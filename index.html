<div id="voice-chatbot-container">
    <div id="status-display">برای شروع روی دکمه میکروفون کلیک کنید</div>
    <button id="record-button">
        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        <div class="loading-circle" id="loading-circle"></div>
    </button>
</div>

<style>
    #voice-chatbot-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f0f4f8;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 350px;
        margin: 40px auto;
    }
    #status-display {
        margin-bottom: 20px;
        font-size: 16px;
        font-weight: 500;
        color: #4a5568;
        min-height: 24px;
        transition: color 0.3s ease;
    }
    #record-button {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(145deg, #007bff, #0056b3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }
    #record-button:hover:not(:disabled) {
        transform: scale(1.05);
    }
    #record-button:disabled {
        cursor: not-allowed;
        background: #cccccc;
    }
    #record-button.recording {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        animation: pulse 1.5s infinite;
        box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5);
    }
    #record-button.loading .mic-icon { display: none; }
    #record-button.loading .loading-circle { display: block; }
    .loading-circle {
        display: none;
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const recordButton = document.getElementById('record-button');
    const statusDisplay = document.getElementById('status-display');
    let mediaRecorder;
    let audioChunks = [];
    let isProcessing = false;

    // !!!!!!! --- قدم ۲: آدرس سرور خود را در اینجا قرار دهید --- !!!!!!!
    const SERVER_URL = "آدرس_کامل_سرور_RENDER_شما_اینجا_قرار_می‌گیرد/process-audio"; 
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    recordButton.addEventListener('click', async () => {
        if (isProcessing) return;

        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });
                mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                    audioChunks = [];
                    sendAudioToServer(audioBlob);
                };
                startRecording();
            } catch (err) {
                statusDisplay.textContent = "اجازه دسترسی به میکروفون داده نشد!";
            }
        }
    });

    function startRecording() {
        recordButton.classList.add('recording');
        statusDisplay.textContent = "در حال ضبط... صحبت کنید (برای توقف کلیک کنید)";
        mediaRecorder.start();
        
        // اگر کاربر دوباره کلیک نکرد، بعد از ۷ ثانیه ضبط متوقف شود
        setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
        }, 7000); 
    }

    function stopRecording() {
        isProcessing = true;
        recordButton.classList.remove('recording');
        statusDisplay.textContent = "در حال پردازش صدا...";
        recordButton.classList.add('loading');
        recordButton.disabled = true;
    }
    
    mediaRecorder.onstop = () => {
        stopRecording();
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
        audioChunks = [];
        sendAudioToServer(audioBlob);
    };


    async function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        try {
            const response = await fetch(SERVER_URL, { method: 'POST', body: formData });
            if (!response.ok) { throw new Error(`Server error: ${response.statusText}`); }
            const responseAudioBlob = await response.blob();
            const audio = new Audio(URL.createObjectURL(responseAudioBlob));
            audio.play();
            statusDisplay.textContent = "برای شروع دوباره کلیک کنید";
        } catch (error) {
            console.error('Error:', error);
            statusDisplay.textContent = "مشکلی پیش آمد. دوباره تلاش کنید.";
        } finally {
            isProcessing = false;
            recordButton.classList.remove('loading');
            recordButton.disabled = false;
        }
    }
});
</script>